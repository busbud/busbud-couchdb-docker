#!/usr/bin/env bash

# we need to set the permissions here because docker mounts volumes as root

chown -R couchdb:couchdb /usr/local/var/lib/couchdb \
  /usr/local/var/log/couchdb \
  /usr/local/var/run/couchdb \
  /usr/local/etc/couchdb

chmod -R 0770 /usr/local/var/lib/couchdb \
  /usr/local/var/log/couchdb \
  /usr/local/var/run/couchdb \
  /usr/local/etc/couchdb

chmod 664 /usr/local/etc/couchdb/*.ini
chmod 775 /usr/local/etc/couchdb/*.d

# Modify configuration file "templates" with current environment
sed -i "s/%LICENSE_KEY%/$NEWRELIC_KEY/" /etc/newrelic/newrelic_plugin_agent.cfg

# Run everything
/usr/bin/supervisord --configuration /etc/supervisor/supervisord.conf